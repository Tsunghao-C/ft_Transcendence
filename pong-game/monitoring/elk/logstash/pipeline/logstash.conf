input {
  beats {
    port => 5044
  }
}

filter {
  # Web Traffic Processing
  if [fields][type] == "nginx" {
    # Common processing for all nginx logs
    mutate {
      add_field => { "type" => "%{[fields][type]}" }
    }

    # Access logs specific processing
    if [fields][source] == "access" {
      json {
        source => "message"
      }
      geoip {
        source => "remote_addr"
        target => "geo"
      }
      useragent {
        source => "http_user_agent"
        target => "user_agent"
      }
    }

    # Error logs specific processing
    if [fields][source] == "error" {
      grok {
        match => { "message" => "%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{TIME} \[%{LOGLEVEL:severity}\] %{POSINT:pid}#%{NUMBER}: %{GREEDYDATA:error_message}" }
      }
    }
  }
  # WAF Log Processing (ModSecurity)
  else if [fields][type] == "waf" {
    mutate {
      add_field => { "type" => "%{[fields][type]}" }
    }
    # Audit log processing
    if [fields][source] == "audit" {
      # Parse ModSecurity audit log sections
      grok {
        match => { "message" => "(?m)^--(%{NOTSPACE:transaction_id})-(%{WORD:section_letter})--\n%{GREEDYDATA:section_content}" }
      }
      
      # Process different sections based on their letter
      if [section_letter] == "A" {
        # Transaction metadata
        grok {
          match => { "section_content" => "\[%{HTTPDATE:timestamp}\] %{NOTSPACE:unique_id} %{IP:client_ip} %{NUMBER:client_port} %{IP:server_ip} %{NUMBER:server_port}" }
        }
        date {
          match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
          target => "@timestamp"
        }
      }
      else if [section_letter] == "B" {
        # Request headers
        grok {
          match => { "section_content" => "(?m)%{WORD:http_method} %{NOTSPACE:uri} %{NOTSPACE:http_version}\n%{GREEDYDATA:request_headers}" }
        }
      }
      else if [section_letter] == "H" {
        # Audit log trailer
        kv {
          source => "section_content"
          field_split => "\n"
          value_split => ": "
        }
        # Parse severity if available
        grok {
          match => { "section_content" => "(?m)^Message: %{GREEDYDATA:waf_message}$" }
        }
      }
    }
    else if [fields][source] == "debug" {
      grok {
        match => { "message" => "(?m)\[%{TIMESTAMP_ISO8601:debug_timestamp}\] \[%{WORD:debug_severity}\] %{GREEDYDATA:debug_message}" }
      }
      date {
        match => [ "debug_timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }

    # Add geo IP data for security analysis
    if [client_ip] {
      geoip {
        source => "client_ip"
        target => "geo"
      }
    }

    # Tag high severity events
    if [debug_severity] == "error" or [section_content] =~ "severity: critical" {
      mutate {
        add_tag => ["high_severity"]
      }
    }
  }
  ## Adding more filters for future data source
  # # Application Logs Processing
  # if [fields][type] == "application" {
  #   if [fields][service] == "auth" {
  #     grok {
  #       match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:log_level} %{GREEDYDATA:message}" }
  #     }
  #     # Add authentication-specific processing
  #   }

  #   if [fields][service] == "game" {
  #     grok {
  #       match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:log_level} %{GREEDYDATA:message}" }
  #     }
  #     # Add game-specific processing
  #   }
  # }
}
    
output {
  # Route logs to different indices based on category
  if [fields][type] == "nginx" {
    if [fields][source] == "access" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "nginx-access-logs-%{+YYYY.MM.dd}"
      }
    }
    else if [fields][source] == "error" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "nginx-error-logs-%{+YYYY.MM.dd}"
      }
    }
  }
  else if [fields][type] == "waf" {
    if [fields][source] == "audit" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "waf-audit-%{+YYYY.MM.dd}"
      }
    }
    else if [fields][source] == "debug" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "waf-debug-%{+YYYY.MM.dd}"
      }
    }
  }
  # # Added later when they are ready
  # else if [category] == "security" {
  #   elasticsearch {
  #     hosts => ["elasticsearch:9200"]
  #     index => "security-logs-%{+YYYY.MM.dd}"
  #   }
  # }
  # else if [category] == "gameplay" {
  #   elasticsearch {
  #     hosts => ["elasticsearch:9200"]
  #     index => "game-logs-%{+YYYY.MM.dd}"
  #   }
  # }
  else {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "other-logs-%{+YYYY.MM.dd}"
    }
  }
  # Debug output
  stdout { codec => rubydebug}
}
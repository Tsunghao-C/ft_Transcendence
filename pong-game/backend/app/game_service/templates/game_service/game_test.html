<!DOCTYPE html>
<html>
<head>
    <title>Pong Game Test</title>
    <style>
        canvas {
            border: 2px solid black;
            margin: 20px auto;
            display: block;
            background-color: #f0f0f0;
        }
        #game-info {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
        }
        #controls {
            text-align: center;
            margin-top: 20px;
        }
        #debug {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            font-family: monospace;
        }
        .status {
            margin: 10px 0;
            font-weight: bold;
        }
        .player-status {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="game-info">Loading...</div>
    <div id="player-status" class="player-status"></div>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="controls">
        <button id="readyButton" style="display: none;">Ready to Play</button>
        <p>Player 1: W (up) / S (donw)</p>
        <p>Player 2: ArrowUp (up) / ArrowDown (down)</p>
    </div>
    <div id="debug"></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameInfo = document.getElementById('game-info');
        const debugDiv = document.getElementById('debug');
        const playerStatus = document.getElementById('player-status');
        const readyButton = document.getElementById('readyButton');
        let playerId = null;
        let lastGameState = null;
        let ws = null;
        let wsReconnectTimer = null;

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.CONNECTING) {
                console.log('Connection already in progress...');
                return;
            }
            const gameId = 'test';
            const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            const wsUrl = `${wsScheme}://${window.location.host}/ws/game-server/${gameId}/`;
            
            console.log('Connecting to WebSocket...')
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected');
                gameInfo.textContent = 'Connected to game server...';
                if (wsReconnectTimer) {
                    clearTimeout(wsReconnectTimer);
                    wsReconnectTimer = null;
                }
            };

            ws.onclose = function(e) {
                console.log('WebSocket closed:', e);
                if (e.code === 1011) {
                    gameInfo.textContent = 'Game is full';
                    return;
                }
                gameInfo.textContent = 'Connection closed. Reconnecting...';
                // Try to reconnect
                if (!wsReconnectTimer) {
                    wsReconnectTimer = setTimeout(connectWebSocket, 3000);
                }
            };

            ws.onerror = function(e) {
                console.error('WebSocket error:', e);
                gameInfo.textContent = 'Connection error';
            };

            ws.onmessage = handleMessage;
        }

        function handleMessage(e) {
            const data = JSON.parse(e.data);
            console.log('Received message:', data);

            switch(data.type) {
                case 'player_assignment':
                    playerId = data.player_id;
                    gameInfo.textContent = `You are Player ${playerId} - Waiting for opponent!`;
                    readyButton.style.display = 'block';
                    readyButton.disabled = true;
                    break;
                
                case 'player_status':
                    const playerCount = data.count;
                    playerStatus.textContent = `Players: ${playerCount}/2`;
                    if (playerCount === 2) {
                        readyButton.disabled = false;
                        gameInfo.textContent = `You are Player ${playerId} - Get Ready!`;
                    }
                    break;

                case 'player_joined':
                    playerStatus.textContent = `Players: ${data.player_count}/2`;
                    break;

                case 'player_ready_status':
                    const readyPlayers = data.ready_players;
                    playerStatus.textContent = `Ready Players: ${readyPlayers.join(', ')}`;
                    if (readyPlayers.includes(playerId)) {
                        readyButton.disabled = true;
                        readyButton.textContent = 'Waiting for other player...';
                    }
                    break;

                case 'game_start':
                    gameInfo.textContent = 'Game Started!';
                    readyButton.style.display = 'none';
                    break;

                case 'game_state_update':
                    lastGameState = data.game_state;
                    drawGame(data.game_state);
                    break;

                case 'game_end':
                    gameInfo.textContent = 'Game Ended: ' + data.message;
                    readyButton.style.display = 'block';
                    readyButton.disabled = false;
                    readyButton.textContent = 'Ready to Play';
                    break;

                case 'error':
                    gameInfo.textContent = 'Error: ' + data.message;
                    break;
            }

            debugDiv.textContent = 'Last message: ' + JSON.stringify(data, null, 2);
        }

        // Track pressed keys
        const keys = {
            'w': false,
            's': false,
            'ArrowUp': false,
            'ArrowDown': false
        };

        readyButton.addEventListener('click', function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'player_ready' }));
                this.disabled = true;
                this.textContent = 'Waiting for other player...';
            }
        });

        function drawGame(gameState) {
            // debug
            console.log('Drawing game state:', {
                ballX: gameState.ball.x,
                ballY: gameState.ball.y,
                ballDx: gameState.ball.dx,
                ballDy: gameState.ball.dy,
                status: gameState.status
            });
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw paddles
            ctx.fillStyle = '#000000';
            Object.entries(gameState.paddles).forEach(([pid, paddle]) => {
                ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
                // Debug paddle position
                ctx.fillStyle = '#ff0000';
                ctx.font = '12px Arial';
                ctx.fillText(`${pid}: ${Math.round(paddle.x)},${Math.round(paddle.y)}`, paddle.x, paddle.y - 5);
                ctx.fillStyle = '#000000';
            });

            // Draw ball
            const ball = gameState.ball;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();
            // Debug ball position
            ctx.fillStyle = '#ff0000';
            ctx.font = '12px Arial';
            ctx.fillText(`ball: ${Math.round(ball.x)},${Math.round(ball.y)}`, ball.x + 15, ball.y);

            // Draw score
            ctx.fillStyle = '#000000';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(gameState.score.p1, canvas.width * 0.25, 50);
            ctx.fillText(gameState.score.p2, canvas.width * 0.75, 50);

            // Draw center line
            ctx.setLineDash([5, 15]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function handleMovement() {
            if (!playerId || !ws || ws.readyState !== WebSocket.OPEN) return;

            let shouldMove = false;
            let direction = null;

            if (playerId === 'p1') {
                if (keys['w']) {
                    direction = 'up';
                    shouldMove = true;
                }
                if (keys['s']) {
                    direction = 'down';
                    shouldMove = true;
                }
            } else if (playerId === 'p2') {
                if (keys['ArrowUp']) {
                    direction = 'up';
                    shouldMove = true;
                }
                if (keys['ArrowDown']) {
                    direction = 'down';
                    shouldMove = true;
                }
            }
            if (shouldMove && direction) {
                console.log(`Sending move command: ${playerId} moving ${direction}`);
                ws.send(JSON.stringify({ type: 'paddle_move', direction: direction }))
            }
        }

        // Keyborad controls
        document.addEventListener('keydown', function(e) {
            console.log('Key pressed:', e.key);
            // const key = e.key.toLowerCase();
            if (e.key in keys) {
                keys[e.key] = true;
                handleMovement();
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', function(e) {
            // const key = e.key.toLocaleLowerCase();
            if (e.key in keys) {
                keys[e.key] = false;
                e.preventDefault();
            }
        });

        // Set up continuous movement while keys are held
        setInterval(handleMovement, 16); // approximately 60 FPS

        // Start connection
        connectWebSocket();

        // // Debug rendering
        // function checkRendering() {
        //     if (lastGameState) {
        //         console.log('Current game state:', lastGameState);
        //         const positions = {
        //             ball: lastGameState.ball ? `(${Math.round(lastGameState.ball.x)}, ${Math.round(lastGameState.ball.y)})` : 'missing',
        //             p1: lastGameState.paddles.p1 ? `(${Math.round(lastGameState.paddles.p1.x)}, ${Math.round(lastGameState.paddles.p1.y)})` : 'missing',
        //             p2: lastGameState.paddles.p2 ? `(${Math.round(lastGameState.paddles.p2.x)}, ${Math.round(lastGameState.paddles.p2.y)})` : 'missing'
        //         };
        //         debugDiv.textContent = 'Positions: ' + JSON.stringify(positions, null, 2);
        //     }
        // }
        // setInterval(checkRendering, 1000); //check every second
    </script>
</body>
</html>

<!-- <!DOCTYPE html>
<html>
<head>
    <title>Game WebSocket Test</title>
</head>
<body>
    <h1>Game ID: {{ game_id }}</h1>
    <div id="game-log" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc;"></div>
    <input id="game-message" type="text">
    <button onclick="sendMessage()">Send</button>

    <script>
        const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${wsScheme}://${window.location.host}/ws/game-server/{{ game_id }}/`;
        const gameSocket = new WebSocket(wsUrl);

        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const log = document.getElementById('game-log');
            log.innerHTML += `<p>${data.message}</p>`;
            log.scrollTop = log.scrollHeight;
        };

        function sendMessage() {
            const messageInput = document.getElementById('game-message');
            gameSocket.send(JSON.stringify({
                'message': messageInput.value
            }));
            messageInput.value = '';
        }
    </script>
</body>
</html> -->